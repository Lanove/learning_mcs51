
ASEM-51 V1.3                                         Copyright (c) 2002 by W.W. Heinz                                         PAGE 1





       MCS-51 Family Macro Assembler   A S E M - 5 1   V 1.3
       =====================================================



	Source File:	i2c.asm
	Object File:	i2c.hex
	List File:	i2c.lst



 Line  I  Addr  Code            Source

    1:				;====================================================================
    2:				; Main.asm file generated by New Project wizard
    3:				;
    4:				; Created:   Thu Apr 25 2024
    5:				; Processor: 80C31
    6:				; Compiler:  ASEM-51 (Proteus)
    7:				;====================================================================
    8:
    9:				$NOMOD51
   10:				$INCLUDE (8051.MCU)
   11: 1			;   8051 processor definition file
   12: 1			;   ==============================
   13: 1
   14: 1	N	 80	P0	DATA	080H
   15: 1	N	 81	SP	DATA	081H
   16: 1	N	 82	DPL	DATA	082H
   17: 1	N	 83	DPH	DATA	083H
   18: 1	N	 87	PCON	DATA	087H
   19: 1	N	 88	TCON	DATA	088H
   20: 1	N	 89	TMOD	DATA	089H
   21: 1	N	 8A	TL0	DATA	08AH
   22: 1	N	 8B	TL1	DATA	08BH
   23: 1	N	 8C	TH0	DATA	08CH
   24: 1	N	 8D	TH1	DATA	08DH
   25: 1	N	 90	P1	DATA	090H
   26: 1	N	 98	SCON	DATA	098H
   27: 1	N	 99	SBUF	DATA	099H
   28: 1	N	 A0	P2	DATA	0A0H
   29: 1	N	 A8	IE	DATA	0A8H
   30: 1	N	 B0	P3	DATA	0B0H
   31: 1	N	 B8	IP	DATA	0B8H
   32: 1	N	 D0	PSW	DATA	0D0H
   33: 1	N	 E0	ACC	DATA	0E0H
   34: 1	N	 F0	B	DATA	0F0H
   35: 1
   36: 1	N	 88	IT0	BIT	088H
   37: 1	N	 89	IE0	BIT	089H
   38: 1	N	 8A	IT1	BIT	08AH
   39: 1	N	 8B	IE1	BIT	08BH
   40: 1	N	 8C	TR0	BIT	08CH
   41: 1	N	 8D	TF0	BIT	08DH
   42: 1	N	 8E	TR1	BIT	08EH
   43: 1	N	 8F	TF1	BIT	08FH

ASEM-51 V1.3                                         Copyright (c) 2002 by W.W. Heinz                                         PAGE 2



 Line  I  Addr  Code            Source

   44: 1	N	 98	RI	BIT	098H
   45: 1	N	 99	TI	BIT	099H
   46: 1	N	 9A	RB8	BIT	09AH
   47: 1	N	 9B	TB8	BIT	09BH
   48: 1	N	 9C	REN	BIT	09CH
   49: 1	N	 9D	SM2	BIT	09DH
   50: 1	N	 9E	SM1	BIT	09EH
   51: 1	N	 9F	SM0	BIT	09FH
   52: 1	N	 A8	EX0	BIT	0A8H
   53: 1	N	 A9	ET0	BIT	0A9H
   54: 1	N	 AA	EX1	BIT	0AAH
   55: 1	N	 AB	ET1	BIT	0ABH
   56: 1	N	 AC	ES	BIT	0ACH
   57: 1	N	 AF	EA	BIT	0AFH
   58: 1	N	 B0	RXD	BIT	0B0H
   59: 1	N	 B1	TXD	BIT	0B1H
   60: 1	N	 B2	INT0	BIT	0B2H
   61: 1	N	 B3	INT1	BIT	0B3H
   62: 1	N	 B4	T0	BIT	0B4H
   63: 1	N	 B5	T1	BIT	0B5H
   64: 1	N	 B6	WR	BIT	0B6H
   65: 1	N	 B7	RD	BIT	0B7H
   66: 1	N	 B8	PX0	BIT	0B8H
   67: 1	N	 B9	PT0	BIT	0B9H
   68: 1	N	 BA	PX1	BIT	0BAH
   69: 1	N	 BB	PT1	BIT	0BBH
   70: 1	N	 BC	PS	BIT	0BCH
   71: 1	N	 D0	P	BIT	0D0H
   72: 1	N	 D2	OV	BIT	0D2H
   73: 1	N	 D3	RS0	BIT	0D3H
   74: 1	N	 D4	RS1	BIT	0D4H
   75: 1	N	 D5	F0	BIT	0D5H
   76: 1	N	 D6	AC	BIT	0D6H
   77: 1	N	 D7	CY	BIT	0D7H
   78: 1
   79: 1	N      0000	RESET	CODE	000H
   80: 1	N      0003	EXTI0	CODE	003H
   81: 1	N      000B	TIMER0	CODE	00BH
   82: 1	N      0013	EXTI1	CODE	013H
   83: 1	N      001B	TIMER1	CODE	01BH
   84: 1	N      0023	SINT	CODE	023H
   85:
   86:				;====================================================================
   87:				; DEFINITIONS
   88:				;====================================================================
   89:
   90:				;====================================================================
   91:				; VARIABLES
   92:				;====================================================================
   93:
   94:				;====================================================================
   95:				; RESET and INTERRUPT VECTORS
   96:				;====================================================================
   97:
   98:				      ; Reset Vector
   99:		N      0000	      org   0000h

ASEM-51 V1.3                                         Copyright (c) 2002 by W.W. Heinz                                         PAGE 3



 Line  I  Addr  Code            Source

  100:	  0000	02 01 00	      jmp   Start
  101:
  102:				;====================================================================
  103:				; CODE SEGMENT
  104:				;====================================================================
  105:
  106:		N      0100	      org   0100h
  107:	  0100			Start:
  108:	  0100	12 01 EB		  call init_lcd
  109:	  0103			Loop:
  110:	  0103	12 02 02		  call lcd_clear
  111:				      ; Write your code here
  112:	  0106	12 01 8A	      call i2c_start
  113:	  0109	74 D0		      mov a,#11010000b
  114:	  010B	12 01 C3	      call i2c_write
  115:	  010E	12 01 B4	      call i2c_ack_tx
  116:	  0111	74 02		      mov a,#02;send address (second)
  117:	  0113	12 01 C3	      call i2c_write
  118:	  0116	12 01 B4	      call i2c_ack_tx
  119:				      ;call i2c_stop
  120:
  121:	  0119	12 01 8A		  call i2c_start
  122:	  011C	74 D1		      mov a,#11010001b
  123:	  011E	12 01 C3	      call i2c_write
  124:	  0121	12 01 B4	      call i2c_ack_tx
  125:	  0124	12 01 CF	      call i2c_read
  126:	  0127	12 01 93		  call i2c_stop
  127:	  012A	F9		      mov r1,a
  128:	  012B	12 02 08	      call lcd_printhex
  129:
  130:	  012E	78 2D		      mov r0,#'-'
  131:	  0130	12 02 1C	      call lcd_print
  132:
  133:	  0133	12 01 8A	      call i2c_start
  134:	  0136	74 D0		      mov a,#11010000b
  135:	  0138	12 01 C3	      call i2c_write
  136:	  013B	12 01 B4	      call i2c_ack_tx
  137:	  013E	74 00		      mov a,#00 ;send address (minute)
  138:	  0140	12 01 C3	      call i2c_write
  139:	  0143	12 01 B4	      call i2c_ack_tx
  140:				      ;call i2c_stop
  141:
  142:	  0146	12 01 8A		  call i2c_start
  143:	  0149	74 D1		      mov a,#11010001b
  144:	  014B	12 01 C3	      call i2c_write
  145:	  014E	12 01 B4	      call i2c_ack_tx
  146:	  0151	12 01 CF	      call i2c_read
  147:	  0154	12 01 93		  call i2c_stop
  148:	  0157	F9		      mov r1,a
  149:	  0158	12 02 08	      call lcd_printhex
  150:
  151:	  015B	78 2D		      mov r0,#'-'
  152:	  015D	12 02 1C	      call lcd_print
  153:
  154:	  0160	12 01 8A	      call i2c_start
  155:	  0163	74 D0		      mov a,#11010000b

ASEM-51 V1.3                                         Copyright (c) 2002 by W.W. Heinz                                         PAGE 4



 Line  I  Addr  Code            Source

  156:	  0165	12 01 C3	      call i2c_write
  157:	  0168	12 01 B4	      call i2c_ack_tx
  158:	  016B	74 01		      mov a,#01;send address (minute)
  159:	  016D	12 01 C3	      call i2c_write
  160:	  0170	12 01 B4	      call i2c_ack_tx
  161:				      ;call i2c_stop
  162:
  163:	  0173	12 01 8A		  call i2c_start
  164:	  0176	74 D1		      mov a,#11010001b
  165:	  0178	12 01 C3	      call i2c_write
  166:	  017B	12 01 B4	      call i2c_ack_tx
  167:	  017E	12 01 CF	      call i2c_read
  168:	  0181	12 01 93		  call i2c_stop
  169:	  0184	F9		      mov r1,a
  170:	  0185	12 02 08	      call lcd_printhex
  171:
  172:	  0188	21 03		      jmp Loop
  173:
  174:	  018A			i2c_start:
  175:	  018A	D2 90		      setb p1.0 ;SCL
  176:	  018C	D2 91		      setb p1.1 ;SDA
  177:	  018E	C2 91		      clr  p1.1
  178:	  0190	C2 90		      clr p1.0
  179:	  0192	22		      ret
  180:
  181:	  0193			i2c_stop:
  182:	  0193	C2 91		      clr p1.1
  183:	  0195	D2 90		      setb p1.0
  184:	  0197	22		      ret
  185:
  186:	  0198			i2c_clk:
  187:	  0198	12 01 DD	      call delay
  188:	  019B	D2 90		      setb p1.0
  189:	  019D	12 01 DD	      call delay
  190:	  01A0	C2 90		      clr p1.0
  191:	  01A2	12 01 DD	      call delay
  192:	  01A5	22		       ret
  193:
  194:	  01A6			i2c_nack:
  195:	  01A6	D2 91		      setb p1.1
  196:	  01A8	D2 90		      setb p1.0
  197:	  01AA	C2 90		      clr p1.0
  198:	  01AC	22		       ret
  199:
  200:	  01AD			i2c_ack_rx:
  201:	  01AD	C2 91		      clr p1.1
  202:	  01AF	D2 90		      setb p1.0
  203:	  01B1	C2 90		      clr p1.0
  204:	  01B3	22			  ret
  205:
  206:
  207:	  01B4			i2c_ack_tx:
  208:	  01B4	D2 90		       setb p1.0
  209:	  01B6	20 91 05	       jb p1.1, failed
  210:	  01B9	C2 92		       clr p1.2
  211:	  01BB	02 01 C0	       jmp end_ack

ASEM-51 V1.3                                         Copyright (c) 2002 by W.W. Heinz                                         PAGE 5



 Line  I  Addr  Code            Source

  212:	  01BE			failed:
  213:	  01BE	D2 92		       setb p1.2
  214:	  01C0			end_ack:
  215:	  01C0	C2 90		       clr p1.0
  216:	  01C2	22		       ret
  217:
  218:	  01C3			i2c_write:
  219:	  01C3	78 08		      mov R0,#08
  220:	  01C5			loop_i2c_write:
  221:	  01C5	33		      rlc a
  222:	  01C6	92 91		      mov p1.1,c
  223:	  01C8	31 98		      call i2c_clk
  224:	  01CA	18		      dec R0
  225:	  01CB	B8 00 F7	      cjne R0,#00,loop_i2c_write
  226:	  01CE	22		      ret
  227:
  228:	  01CF			 i2c_read:
  229:	  01CF	78 08		      mov R0,#08
  230:	  01D1	74 00			  mov a,#00
  231:	  01D3			loop_i2c_read:
  232:	  01D3	A2 91		      mov c,p1.1
  233:	  01D5	33		      rlc a
  234:	  01D6	31 98		      call i2c_clk
  235:	  01D8	18		      dec R0
  236:	  01D9	B8 00 F7	      cjne R0,#00,loop_i2c_read
  237:	  01DC	22		      ret
  238:
  239:	  01DD			delay:
  240:	  01DD	7E 0A			mov r6,#10
  241:	  01DF	7F 0A			mov r7,#10
  242:	  01E1			 delay_loop2:
  243:	  01E1			 delay_loop:
  244:	  01E1	1E			dec r6
  245:	  01E2	00		    nop
  246:	  01E3	BE 00 FB	    cjne r6,#00, delay_loop
  247:	  01E6	1F		    dec r7
  248:	  01E7	BF 00 F7		cjne r7,#00, delay_loop
  249:	  01EA	22		      ret
  250:
  251:	  01EB			init_lcd:
  252:	  01EB	79 23		      mov r1,#023h
  253:	  01ED	78 38		      mov r0,#00111000b ;function set
  254:	  01EF	12 02 20		  call send_inst
  255:	  01F2	78 06		      mov r0,#00000110b ;entry mode
  256:	  01F4	12 02 20		  call send_inst
  257:	  01F7	78 0C		      mov r0,#00001100b ;display on/off control
  258:	  01F9	12 02 20		  call send_inst
  259:	  01FC	78 01		      mov r0,#00000001b ;clear display
  260:	  01FE	12 02 20		  call send_inst
  261:	  0201	22		      ret
  262:
  263:	  0202			lcd_clear:
  264:	  0202	78 01		      mov r0,#00000001b ;clear display
  265:	  0204	12 02 20		  call send_inst
  266:	  0207	22		      ret
  267:

ASEM-51 V1.3                                         Copyright (c) 2002 by W.W. Heinz                                         PAGE 6



 Line  I  Addr  Code            Source

  268:	  0208			lcd_printhex:
  269:	  0208	E9		      mov a,r1
  270:	  0209	75 F0 10	      mov b,#010h
  271:	  020C	84		      div ab
  272:
  273:	  020D	24 30		      add a,#030h
  274:	  020F	F8		      mov r0,a
  275:	  0210	12 02 31		  call send_data
  276:
  277:	  0213	E5 F0		      mov a,b
  278:	  0215	24 30		      add a,#030h
  279:	  0217	F8		      mov r0,a
  280:	  0218	12 02 31		  call send_data
  281:	  021B	22		      ret
  282:
  283:	  021C			lcd_print:
  284:	  021C	12 02 31		  call send_data
  285:	  021F	22		      ret
  286:
  287:	  0220			send_inst:
  288:	  0220	C2 A6		      clr p2.6
  289:	  0222	D2 A7		      setb p2.7
  290:	  0224	88 B0		      mov p3,r0
  291:	  0226	12 02 42		  call delay_lcd
  292:	  0229	C2 A7		      clr p2.7
  293:	  022B	D2 A7		      setb p2.7
  294:	  022D	12 02 42		  call delay_lcd
  295:	  0230	22		      ret
  296:	  0231			send_data:
  297:	  0231	D2 A6		      setb p2.6
  298:	  0233	D2 A7		      setb p2.7
  299:	  0235	88 B0		      mov p3,r0
  300:	  0237	12 02 42		  call delay_lcd
  301:	  023A	C2 A7		      clr p2.7
  302:	  023C	D2 A7		      setb p2.7
  303:	  023E	12 02 42		  call delay_lcd
  304:	  0241	22		      ret
  305:
  306:	  0242			delay_lcd:
  307:	  0242	7E 37			mov r6,#055
  308:	  0244	7F 37			mov r7,#055
  309:	  0246			 delay_loop2lcd:
  310:	  0246			 delay_looplcd:
  311:	  0246	1E			dec r6
  312:	  0247	00		    nop
  313:	  0248	BE 00 FB	    cjne r6,#00, delay_looplcd
  314:	  024B	1F		    dec r7
  315:	  024C	BF 00 F7		cjne r7,#00, delay_loop2lcd
  316:	  024F	22		    ret
  317:				;====================================================================
  318:				      END






ASEM-51 V1.3                                         Copyright (c) 2002 by W.W. Heinz                                         PAGE 7



                     register banks used:  ---

                     no errors




ASEM-51 V1.3                                         Copyright (c) 2002 by W.W. Heinz                                         PAGE 8





	       L I S T   O F   S Y M B O L S
	       =============================


SYMBOL				  TYPE     VALUE	LINE
------------------------------------------------------------
??ASEM_51			  NUMBER    8051
??VERSION			  NUMBER    0130
AC				  BIT	      D6	  76
ACC				  DATA	      E0	  33
B				  DATA	      F0	  34
CY				  BIT	      D7	  77
DELAY				  CODE	    01DD	 239
DELAY_LCD			  CODE	    0242	 306
DELAY_LOOP			  CODE	    01E1	 243
DELAY_LOOP2			  CODE	    01E1	 242
DELAY_LOOP2LCD			  CODE	    0246	 309
DELAY_LOOPLCD			  CODE	    0246	 310
DPH				  DATA	      83	  17
DPL				  DATA	      82	  16
EA				  BIT	      AF	  57
END_ACK				  CODE	    01C0	 214
ES				  BIT	      AC	  56
ET0				  BIT	      A9	  53
ET1				  BIT	      AB	  55
EX0				  BIT	      A8	  52
EX1				  BIT	      AA	  54
EXTI0				  CODE	    0003	  80
EXTI1				  CODE	    0013	  82
F0				  BIT	      D5	  75
FAILED				  CODE	    01BE	 212
I2C_ACK_RX			  CODE	    01AD	 200
I2C_ACK_TX			  CODE	    01B4	 207
I2C_CLK				  CODE	    0198	 186
I2C_NACK			  CODE	    01A6	 194
I2C_READ			  CODE	    01CF	 228
I2C_START			  CODE	    018A	 174
I2C_STOP			  CODE	    0193	 181
I2C_WRITE			  CODE	    01C3	 218
IE				  DATA	      A8	  29
IE0				  BIT	      89	  37
IE1				  BIT	      8B	  39
INIT_LCD			  CODE	    01EB	 251
INT0				  BIT	      B2	  60
INT1				  BIT	      B3	  61
IP				  DATA	      B8	  31
IT0				  BIT	      88	  36
IT1				  BIT	      8A	  38
LCD_CLEAR			  CODE	    0202	 263
LCD_PRINT			  CODE	    021C	 283
LCD_PRINTHEX			  CODE	    0208	 268
LOOP				  CODE	    0103	 109
LOOP_I2C_READ			  CODE	    01D3	 231
LOOP_I2C_WRITE			  CODE	    01C5	 220
OV				  BIT	      D2	  72
P				  BIT	      D0	  71

ASEM-51 V1.3                                         Copyright (c) 2002 by W.W. Heinz                                         PAGE 9



SYMBOL				  TYPE     VALUE	LINE
------------------------------------------------------------
P0				  DATA	      80	  14
P1				  DATA	      90	  25
P2				  DATA	      A0	  28
P3				  DATA	      B0	  30
PCON				  DATA	      87	  18
PS				  BIT	      BC	  70
PSW				  DATA	      D0	  32
PT0				  BIT	      B9	  67
PT1				  BIT	      BB	  69
PX0				  BIT	      B8	  66
PX1				  BIT	      BA	  68
RB8				  BIT	      9A	  46
RD				  BIT	      B7	  65
REN				  BIT	      9C	  48
RESET				  CODE	    0000	  79
RI				  BIT	      98	  44
RS0				  BIT	      D3	  73
RS1				  BIT	      D4	  74
RXD				  BIT	      B0	  58
SBUF				  DATA	      99	  27
SCON				  DATA	      98	  26
SEND_DATA			  CODE	    0231	 296
SEND_INST			  CODE	    0220	 287
SINT				  CODE	    0023	  84
SM0				  BIT	      9F	  51
SM1				  BIT	      9E	  50
SM2				  BIT	      9D	  49
SP				  DATA	      81	  15
START				  CODE	    0100	 107
T0				  BIT	      B4	  62
T1				  BIT	      B5	  63
TB8				  BIT	      9B	  47
TCON				  DATA	      88	  19
TF0				  BIT	      8D	  41
TF1				  BIT	      8F	  43
TH0				  DATA	      8C	  23
TH1				  DATA	      8D	  24
TI				  BIT	      99	  45
TIMER0				  CODE	    000B	  81
TIMER1				  CODE	    001B	  83
TL0				  DATA	      8A	  21
TL1				  DATA	      8B	  22
TMOD				  DATA	      89	  20
TR0				  BIT	      8C	  40
TR1				  BIT	      8E	  42
TXD				  BIT	      B1	  59
WR				  BIT	      B6	  64
